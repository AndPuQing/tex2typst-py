(()=>{function Re(e){return"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".includes(e)}function d(e,n="Assertion failed."){if(!e)throw new Error(n)}var o=class U{type;value;constructor(n,r){this.type=n,this.value=r}eq(n){return this.type===n.type&&this.value===n.value}toString(){switch(this.type){case 4:return"%"+this.value;default:return this.value}}toNode(){return new Be(this)}static EMPTY=new U(0,"");static COMMAND_DISPLAYSTYLE=new U(2,"\\displaystyle");static COMMAND_TEXTSTYLE=new U(2,"\\textstyle")},T=class{type;head;constructor(e,n){this.type=e,this.head=n||o.EMPTY}eq(e){return this.type===e.type&&this.head.eq(e.head)}toString(){return this.serialize().reduce(_e,"")}},Be=class extends T{constructor(e){super("terminal",e)}serialize(){switch(this.head.type){case 0:return[];case 1:case 2:case 3:case 4:case 7:return[this.head];case 5:case 6:{let e=[];for(let n of this.head.value){let r=n===" "?5:6;e.push(new o(r,n))}return e}default:throw new Error(`Unknown terminal token type: ${this.head.type}`)}}},H=class extends T{constructor(e){d(e.type===3),super("text",e)}serialize(){return[new o(2,"\\text"),new o(1,"{"),this.head,new o(1,"}")]}},q=class extends T{items;constructor(e){super("ordgroup",o.EMPTY),this.items=e}serialize(){return this.items.map(e=>e.serialize()).flat()}},J=class extends T{base;sup;sub;constructor(e){super("supsub",o.EMPTY),this.base=e.base,this.sup=e.sup,this.sub=e.sub}serialize(){let e=[],{base:n,sup:r,sub:t}=this;e=e.concat(n.serialize());function a(s){return s.type==="ordgroup"||s.type==="supsub"||s.head.type===0?!0:!!(s.head.type===1&&/\d+(\.\d+)?/.test(s.head.value)&&s.head.value.length>1)}return t&&(e.push(new o(7,"_")),a(t)?(e.push(new o(1,"{")),e=e.concat(t.serialize()),e.push(new o(1,"}"))):e=e.concat(t.serialize())),r&&(e.push(new o(7,"^")),a(r)?(e.push(new o(1,"{")),e=e.concat(r.serialize()),e.push(new o(1,"}"))):e=e.concat(r.serialize())),e}},m=class extends T{args;data;constructor(e,n,r=null){super("funcCall",e),this.args=n,this.data=r}serialize(){let e=[];e.push(this.head),this.head.value==="\\sqrt"&&this.data&&(e.push(new o(1,"[")),e=e.concat(this.data.serialize()),e.push(new o(1,"]")));for(let n of this.args)e.push(new o(1,"{")),e=e.concat(n.serialize()),e.push(new o(1,"}"));return e}},ee=class extends T{body;left;right;constructor(e){super("leftright",o.EMPTY),this.body=e.body,this.left=e.left,this.right=e.right}serialize(){let e=[];return e.push(new o(2,"\\left")),e.push(new o(1,this.left?this.left.value:".")),e=e.concat(this.body.serialize()),e.push(new o(2,"\\right")),e.push(new o(1,this.right?this.right.value:".")),e}},O=class extends T{matrix;data;constructor(e,n,r=null){d(e.type===3),super("beginend",e),this.matrix=n,this.data=r}serialize(){let e=[],n=this.matrix;e.push(new o(2,"\\begin")),e.push(new o(1,"{")),e=e.concat(this.head),e.push(new o(1,"}")),e.push(new o(6,`
`));for(let r=0;r<n.length;r++){let t=n[r];for(let a=0;a<t.length;a++){let s=t[a];e=e.concat(s.serialize()),a!==t.length-1&&e.push(new o(7,"&"))}r!==n.length-1&&e.push(new o(7,"\\\\"))}return e.push(new o(6,`
`)),e.push(new o(2,"\\end")),e.push(new o(1,"{")),e=e.concat(this.head),e.push(new o(1,"}")),e}};function _e(e,n){let r=n.toString(),t=!1;return n.type===5?t=!0:(t||=/[{\(\[\|]$/.test(e),t||=/\\\w+$/.test(e)&&r==="[",t||=/^[\.,;:!\?\(\)\]{}_^]$/.test(r),t||=["\\{","\\}"].includes(r),t||=r==="'",t||=e.endsWith("_")||e.endsWith("^"),t||=/\s$/.test(e),t||=/^\s/.test(r),t||=e==="",t||=/[\(\[{]\s*(-|\+)$/.test(e)||e==="-"||e==="+",t||=e.endsWith("&")&&r==="=",t||=/\d$/.test(e)&&/^[a-zA-Z]$/.test(r)),t||(e+=" "),e+r}function ye(e,n,r=0){let t=e.slice(r).findIndex(a=>a.eq(n));return t===-1?-1:t+r}function xe(e,n){return e.some(r=>r.eq(n))}function Y(e,n){let r=[],t=[];for(let a of e)a.eq(n)?(r.push(t),t=[]):t.push(a);return r.push(t),r}function Pe(e,n){return e.flatMap((r,t)=>t!==e.length-1?[...r,n]:r)}function Ue(e,n){return e.flatMap((r,t)=>t!==e.length-1?[r,n]:[r])}var Ee={};function He(e,n){let r=e.reMatchArray[0].length,t=n.reMatchArray[0].length;return t!==r?t-r:e.index-n.index}var Ie=class{_input;_lexer;_pos=0;_line=0;_col=0;_offset=0;_less=null;_go=!1;_newstate=null;_state;_text=null;_leng=null;_reMatchArray=null;constructor(e,n){this._input=e,this._lexer=n,this._state=n.states[0]}text(){return this._text}leng(){return this._leng}reMatchArray(){return this._reMatchArray}pos(){return this._pos}line(){return this._line}column(){return this._col}input(){return this._input.charAt(this._pos+this._leng+this._offset++)}unput(){return this._offset=this._offset>0?this._offset--:0}less(e){return this._less=e,this._offset=0,this._text=this._text.substring(0,e),this._leng=this._text.length}pushback(e){return this.less(this._leng-e)}reject(){this._go=!0}begin(e){if(this._lexer.specification[e])return this._newstate=e;let n=this._lexer.states[parseInt(e)];if(n)return this._newstate=n;throw"Unknown state '"+e+"' requested"}state(){return this._state}scan(){if(this._pos>=this._input.length)return Ee;let e=this._input.substring(this._pos),n=this._lexer.specification[this._state],r=[];for(let c=0;c<n.length;c++){let h=n[c],p=e.match(h.re);p!==null&&p[0].length>0&&r.push({index:c,rule:h,reMatchArray:p})}if(r.length===0)throw new Error("No match found for input '"+e+"'");r.sort(He),this._go=!0;let t,a;for(let c=0,h=r.length;c<h&&this._go;c++){this._offset=0,this._less=null,this._go=!1,this._newstate=null;let p=r[c];if(a=p.reMatchArray[0],this._text=a,this._leng=a.length,this._reMatchArray=p.reMatchArray,t=p.rule.action(this),this._newstate&&this._newstate!=this._state){this._state=this._newstate;break}}let s=this._less===null?a:a.substring(0,this._less),i=s.length;this._pos+=i+this._offset;let u=s.match(/\n/g);return u!==null?(this._line+=u.length,this._col=i-s.lastIndexOf(`
`)-1):this._col+=i,t}},Se=class{states;specification;constructor(e){this.states=Object.keys(e),this.specification={};for(let n of this.states){let r=e[n];if(n in this.specification)throw"Duplicate state declaration encountered for state '"+n+"'";this.specification[n]=[];for(let[t,a]of r.entries()){let s;try{s=new RegExp("^"+t)}catch(i){throw"Invalid regexp '"+t+"' in state '"+n+"' ("+i.message+")"}this.specification[n].push({re:s,action:a})}}}scanner(e){return new Ie(e,this)}lex(e,n){let r=this.scanner(e);for(;;){let t=r.scan();if(t===Ee)return;t!==void 0&&n(t)}}collect(e){let n=[],r=function(t){Array.isArray(t)?n.push(...t):n.push(t)};return this.lex(e,r),n}},le=["sqrt","text","bar","bold","boldsymbol","ddot","dot","hat","mathbb","mathbf","mathcal","mathfrak","mathit","mathrm","mathscr","mathsf","mathtt","operatorname","overbrace","overline","pmb","rm","tilde","underbrace","underline","vec","widehat","widetilde","overleftarrow","overrightarrow","hspace","substack","set","displaylines","mathinner","mathrel","mathbin","mathop","not"],ie=["frac","tfrac","binom","dbinom","dfrac","tbinom","overset","underset","textcolor"];function $e(e){let n=["{","}","\\","$","&","#","_","%"];for(let r of n)e=e.replaceAll("\\"+r,r);return e}var Ye=new Map([[String.raw`\\begin{(array|subarry)}{(.+?)}`,e=>{let n=e.reMatchArray();return[new o(2,"\\begin"),new o(7,"{"),new o(3,n[1]),new o(7,"}"),new o(7,"{"),new o(3,n[2]),new o(7,"}")]}],[String.raw`\\(text|operatorname|textcolor|begin|end|hspace|array){(.+?)}`,e=>{let n=e.reMatchArray();return[new o(2,"\\"+n[1]),new o(7,"{"),new o(3,$e(n[2])),new o(7,"}")]}],[String.raw`%[^\n]*`,e=>new o(4,e.text().substring(1))],[String.raw`[{}_^&]`,e=>new o(7,e.text())],[String.raw`\\[\\,:;!> ]`,e=>new o(7,e.text())],[String.raw`~`,e=>new o(7,e.text())],[String.raw`\r?\n`,e=>new o(6,`
`)],[String.raw`\s+`,e=>new o(5,e.text())],[String.raw`\\[{}%$&#_|]`,e=>new o(1,e.text())],[String.raw`(\\[a-zA-Z]+)(\s*\d|\s+[a-zA-Z])\s*([0-9a-zA-Z])`,e=>{let n=e.reMatchArray(),r=n[1];if(ie.includes(r.substring(1))){let t=n[2].trimStart(),a=n[3];return[new o(2,r),new o(1,t),new o(1,a)]}else return e.reject(),[]}],[String.raw`(\\[a-zA-Z]+)(\s*\d|\s+[a-zA-Z])`,e=>{let n=e.reMatchArray(),r=n[1];if(le.includes(r.substring(1))){let t=n[2].trimStart();return[new o(2,r),new o(1,t)]}else return e.reject(),[]}],[String.raw`\\[a-zA-Z]+`,e=>new o(2,e.text())],[String.raw`[0-9]+(\.[0-9]+)?`,e=>new o(1,e.text())],[String.raw`[a-zA-Z]`,e=>new o(1,e.text())],[String.raw`[+\-*/='<>!.,;:?()\[\]|]`,e=>new o(1,e.text())],[String.raw`[^\x00-\x7F]`,e=>new o(1,e.text())],[String.raw`.`,e=>new o(8,e.text())]]),Fe={start:Ye};function Te(e){return new Se(Fe).collect(e)}var Ge=["bigl","bigr","bigm","biggl","biggr","biggm","Bigl","Bigr","Bigm","Biggl","Biggr","Biggm"],V=o.EMPTY.toNode();function We(e){return le.includes(e)?1:ie.includes(e)?2:0}var B=new o(7,"{"),A=new o(7,"}"),je=new o(1,"["),Ve=new o(1,"]");function P(e,n){let r=n;for(;r<e.length&&[5,6].includes(e[r].type);)r++;return e.slice(n,r)}function he(e,n){let r=e[n];return r.type===1&&["(",")","[","]","|","\\{","\\}",".","\\|"].includes(r.value)||r.type===2&&["lfloor","rfloor","lceil","rceil","langle","rangle","lparen","rparen","lbrace","rbrace"].includes(r.value.slice(1))?r:null}function M(e,n){let r=n;for(;r<e.length&&e[r].eq(new o(1,"'"));)r+=1;return r-n}var pe=new o(2,"\\left"),de=new o(2,"\\right"),we=new o(2,"\\begin"),ge=new o(2,"\\end"),Xe=new o(7,"\\\\"),w=class x extends Error{constructor(n){super(n),this.name="LatexParserError"}static UNMATCHED_LEFT_BRACE=new x("Unmatched '\\{'");static UNMATCHED_RIGHT_BRACE=new x("Unmatched '\\}'");static UNMATCHED_LEFT_BRACKET=new x("Unmatched '\\['");static UNMATCHED_RIGHT_BRACKET=new x("Unmatched '\\]'");static UNMATCHED_COMMAND_BEGIN=new x("Unmatched '\\begin'");static UNMATCHED_COMMAND_END=new x("Unmatched '\\end'");static UNMATCHED_COMMAND_LEFT=new x("Unmatched '\\left'");static UNMATCHED_COMMAND_RIGHT=new x("Unmatched '\\right'")},re=new o(7,"_"),te=new o(7,"^"),Ke=class{space_sensitive;newline_sensitive;alignmentDepth=0;constructor(e=!1,n=!0){this.space_sensitive=e,this.newline_sensitive=n}parse(e){return this.parseGroup(e.slice(0))}parseGroup(e){let[n,r]=this.parseClosure(e,0,null);return n}parseClosure(e,n,r){let t=[],a=n;for(;a<e.length&&!(r!==null&&e[a].eq(r));){let[u,c]=this.parseNextExpr(e,a);a=c,!((u.head.type===5||u.head.type===6)&&(!this.space_sensitive&&u.head.value.replace(/ /g,"").length===0||!this.newline_sensitive&&u.head.value===`
`))&&t.push(u)}if(a>=e.length&&r!==null)return[V,-1];let s=this.applyStyleCommands(t),i;return s.length===1?i=s[0]:i=new q(s),[i,a+1]}parseNextExpr(e,n){let[r,t]=this.parseNextExprWithoutSupSub(e,n),a=null,s=null,i=0;if(i+=M(e,t),t+=i,t<e.length){let u=e[t];if(u.eq(re)){[a,t]=this.parseNextExprWithoutSupSub(e,t+1);let c=M(e,t);if(i+=c,t+=c,t<e.length&&e[t].eq(te)&&([s,t]=this.parseNextExprWithoutSupSub(e,t+1),M(e,t)>0))throw new w("Double superscript")}else if(u.eq(te)){if([s,t]=this.parseNextExprWithoutSupSub(e,t+1),M(e,t)>0)throw new w("Double superscript");if(t<e.length&&e[t].eq(re)&&([a,t]=this.parseNextExprWithoutSupSub(e,t+1),M(e,t)>0))throw new w("Double superscript")}}if(a!==null||s!==null||i>0){let u={base:r,sup:null,sub:null};if(a&&(u.sub=a),i>0){let c=[];for(let h=0;h<i;h++)c.push(new o(1,"'").toNode());s&&c.push(s),u.sup=c.length===1?c[0]:new q(c)}else s&&(u.sup=s);return[new J(u),t]}else return[r,t]}parseNextExprWithoutSupSub(e,n){if(n>=e.length)throw new w("Unexpected end of input");let r=e[n];switch(r.type){case 1:case 3:case 4:case 5:case 6:return[r.toNode(),n+1];case 2:let t=r.value.slice(1);if(Ge.includes(t))return this.parseNextExprWithoutSupSub(e,n+1);if(r.eq(we))return this.parseBeginEndExpr(e,n);if(r.eq(ge))throw w.UNMATCHED_COMMAND_END;if(r.eq(pe))return this.parseLeftRightExpr(e,n);if(r.eq(de))throw w.UNMATCHED_COMMAND_RIGHT;return this.parseCommandExpr(e,n);case 7:switch(r.value){case"{":let[s,i]=this.parseClosure(e,n+1,A);if(i===-1)throw w.UNMATCHED_LEFT_BRACE;return[s,i];case"}":throw w.UNMATCHED_RIGHT_BRACE;case"\\\\":case"\\!":case"\\,":case"\\:":case"\\;":case"\\>":return[r.toNode(),n+1];case"\\ ":case"~":return[r.toNode(),n+1];case"_":case"^":return[V,n];case"&":if(this.alignmentDepth<=0)throw new w("Unexpected & outside of an alignment");return[r.toNode(),n+1];default:throw new w("Unknown control sequence")}default:throw new w("Unknown token type")}}parseCommandExpr(e,n){d(e[n].type===2);let r=e[n],t=r.value,a=n+1;switch(We(t.slice(1))){case 0:return[r.toNode(),a];case 1:{if(a>=e.length)throw new w("Expecting argument for "+t);if(t==="\\sqrt"&&a<e.length&&e[a].eq(je)){let[c,h]=this.parseClosure(e,a+1,Ve);if(h===-1)throw w.UNMATCHED_LEFT_BRACKET;let[p,y]=this.parseNextArg(e,h);return[new m(r,[p],c),y]}else if(t==="\\text"){if(a+2>=e.length)throw new w("Expecting content for \\text command");d(e[a].eq(B)),d(e[a+1].type===3),d(e[a+2].eq(A));let c=e[a+1];return[new H(c),a+3]}else if(t==="\\displaylines"){d(e[a].eq(B));let[c,h]=this.parseAligned(e,a+1,A);if(h===-1)throw w.UNMATCHED_LEFT_BRACE;let p=new q(Pe(c,Xe.toNode()));return[new m(r,[p]),h]}let[i,u]=this.parseNextArg(e,a);return[new m(r,[i]),u]}case 2:{let[i,u]=this.parseNextArg(e,a),[c,h]=this.parseNextArg(e,u);return[new m(r,[i,c]),h]}default:throw new Error("Invalid number of parameters")}}parseNextArg(e,n){let r=n,t=null;for(;r<e.length;){let a;if([a,r]=this.parseNextExprWithoutSupSub(e,r),!(a.head.type===5||a.head.type===6)){t=a;break}}if(t===null)throw new w("Expecting argument but token stream ended");return[t,r]}parseLeftRightExpr(e,n){d(e[n].eq(pe));let r=n+1;if(r+=P(e,r).length,r>=e.length)throw new w("Expecting a delimiter after \\left");let t=he(e,r);if(t===null)throw new w("Invalid delimiter after \\left");r++;let[a,s]=this.parseClosure(e,r,de);if(s===-1)throw w.UNMATCHED_COMMAND_LEFT;if(r=s,r+=P(e,r).length,r>=e.length)throw new w("Expecting a delimiter after \\right");let i=he(e,r);if(i===null)throw new w("Invalid delimiter after \\right");r++;let u=t.value==="."?null:t,c=i.value==="."?null:i;return[new ee({body:a,left:u,right:c}),r]}parseBeginEndExpr(e,n){d(e[n].eq(we));let r=n+1;d(e[r].eq(B)),d(e[r+1].type===3),d(e[r+2].eq(A));let t=e[r+1].value;r+=3;let a=null;["array","subarray"].includes(t)&&(r+=P(e,r).length,[a,r]=this.parseNextArg(e,r));let[s,i]=this.parseAligned(e,r,ge);if(i===-1)throw w.UNMATCHED_COMMAND_BEGIN;if(r=i,d(e[r].eq(B)),d(e[r+1].type===3),d(e[r+2].eq(A)),e[r+1].value!==t)throw new w("\\begin and \\end environments mismatch");return r+=3,[new O(new o(3,t),s,a),r]}parseAligned(e,n,r){this.alignmentDepth++;let t=n;t+=P(e,t).length;let a;if([a,t]=this.parseClosure(e,t,r),t===-1)return[[],-1];let s;if(a.type==="ordgroup"){let i=a.items;for(;i.length>0&&[5,6].includes(i[i.length-1].head.type);)i.pop();s=Y(i,new o(7,"\\\\").toNode()).map(u=>Y(u,new o(7,"&").toNode()).map(c=>new q(c)))}else s=[[a]];return this.alignmentDepth--,[s,t]}applyStyleCommands(e){for(let n=0;n<e.length;n++){let r=this.getStyleToken(e[n]);if(r){let t=this.applyStyleCommands(e.slice(0,n)),a=this.applyStyleCommands(e.slice(n+1)),s;a.length===0?s=V:a.length===1?s=a[0]:s=new q(a);let i=new m(r,[s]);return t.concat(i)}}return e}getStyleToken(e){return e.type==="terminal"&&(e.head.eq(o.COMMAND_DISPLAYSTYLE)||e.head.eq(o.COMMAND_TEXTSTYLE))?e.head:null}};function Ze(e){let n=t=>t.eq(re)||t.eq(te),r=[];for(let t=0;t<e.length;t++)e[t].type===5&&t+1<e.length&&n(e[t+1])||e[t].type===5&&t-1>=0&&n(e[t-1])||r.push(e[t]);return r}function Qe(e,n){let r=[];for(let t of e)if(t.type===2&&n[t.value]){let a=Te(n[t.value]);r=r.concat(a)}else r.push(t);return r}function Je(e,n={}){let r=new Ke,t=Te(e);return t=Ze(t),t=Qe(t,n),r.parse(t)}var ne=new Map([["arrow.l.r.double.long","<==>"],["arrow.l.r.long","<-->"],["arrow.r.bar","|->"],["arrow.r.double.bar","|=>"],["arrow.r.double.long","==>"],["arrow.r.long","-->"],["arrow.r.long.squiggly","~~>"],["arrow.r.tail",">->"],["arrow.r.twohead","->>"],["arrow.l.double.long","<=="],["arrow.l.long","<--"],["arrow.l.long.squiggly","<~~"],["arrow.l.tail","<-<"],["arrow.l.twohead","<<-"],["arrow.l.r.double","<=>"],["colon.double.eq","::="],["dots.h","..."],["gt.triple",">>>"],["lt.triple","<<<"],["arrow.r","->"],["arrow.r.double","=>"],["arrow.r.squiggly","~>"],["arrow.l","<-"],["arrow.l.squiggly","<~"],["bar.v.double","||"],["bracket.l.stroked","[|"],["bracket.r.stroked","|]"],["colon.eq",":="],["eq.colon","=:"],["eq.not","!="],["gt.double",">>"],["gt.eq",">="],["lt.double","<<"],["lt.eq","<="],["ast.op","*"],["minus","-"],["tilde.op","~"],["arrow.l.r","<->"]]),oe=new Map;for(let[e,n]of ne.entries())n.length>1&&oe.set(n,e);var l=class f{type;value;constructor(n,r){this.type=n,this.value=r}eq(n){return this.type===n.type&&this.value===n.value}isOneOf(n){return xe(n,this)}toNode(){return new ke(this)}toString(){switch(this.type){case 4:return`"${this.value}"`;case 5:return`//${this.value}`;default:return this.value}}static NONE=new f(0,"#none");static EMPTY=new f(2,"");static LEFT_BRACE=new f(2,"{");static RIGHT_BRACE=new f(2,"}");static LEFT_DELIMITERS=[new f(2,"("),new f(2,"["),new f(2,"{"),new f(2,"|"),new f(1,"chevron.l"),new f(1,"paren.l"),new f(1,"brace.l")];static RIGHT_DELIMITERS=[new f(2,")"),new f(2,"]"),new f(2,"}"),new f(2,"|"),new f(1,"chevron.r"),new f(1,"paren.r"),new f(1,"brace.r")]},er=class extends Error{node;constructor(e,n){super(e),this.name="TypstWriterError",this.node=n}},L=new l(7," "),E=class{type;head;options;constructor(e,n){this.type=e,this.head=n||l.NONE}setOptions(e){this.options=e}eq(e){return this.type===e.type&&this.head.eq(e.head)}toString(){throw new Error("Unimplemented toString() in base class TypstNode")}},ke=class extends E{constructor(e){super("terminal",e)}isOverHigh(){return!1}toString(){return this.head.toString()}serialize(e,n){if(this.head.type===2){if(this.head.value===","&&e.insideFunctionDepth>0)return[new l(1,"comma")]}else if(this.head.type===1){let r=this.head.value;return n.preferShorthands&&ne.has(r)&&(r=ne.get(r)),n.inftyToOo&&r==="infinity"&&(r="oo"),[new l(1,r)]}else if(this.head.type===6||this.head.type===8){let r=[];for(let t of this.head.value)if(t===" ")n.keepSpaces&&r.push(new l(6,t));else if(t===`
`)r.push(new l(1,t));else throw new er(`Unexpected whitespace character: ${t}`,this);return r}return[this.head]}},z=class extends E{items;constructor(e){super("group",l.NONE),this.items=e}isOverHigh(){return this.items.some(e=>e.isOverHigh())}serialize(e,n){let r=this.items.flatMap(t=>t.serialize(e,n));return r.length>0&&r[0].eq(L)&&r.shift(),r.length>0&&r[r.length-1].eq(L)&&r.pop(),r}},G=class extends E{base;sup;sub;constructor(e){super("supsub",l.NONE),this.base=e.base,this.sup=e.sup,this.sub=e.sub}isOverHigh(){return this.base.isOverHigh()}serialize(e,n){let r=[],{base:t,sup:a,sub:s}=this;r.push(...t.serialize(e,n));let i=a&&a.head.eq(new l(2,"'"));return i&&r.push(new l(2,"'")),s&&(r.push(new l(2,"_")),r.push(...s.serialize(e,n))),a&&!i&&(r.push(new l(2,"^")),r.push(...a.serialize(e,n))),r.push(L),r}},b=class extends E{args;constructor(e,n){super("funcCall",e),this.args=n}isOverHigh(){return this.head.value==="frac"?!0:this.args.some(e=>e.isOverHigh())}serialize(e,n){let r=[],t=this.head;r.push(t),e.insideFunctionDepth++,r.push(W);for(let a=0;a<this.args.length;a++)r.push(...this.args[a].serialize(e,n)),a<this.args.length-1&&r.push(new l(2,","));if(this.options)for(let[a,s]of Object.entries(this.options))r.push(new l(3,`, ${a}: ${s.toString()}`));return r.push(j),e.insideFunctionDepth--,r}},Ne=class extends E{args;constructor(e){super("fraction",l.NONE),this.args=e}isOverHigh(){return!0}serialize(e,n){let r=[],[t,a]=this.args;return r.push(L),r.push(...t.serialize(e,n)),r.push(new l(2,"/")),r.push(...a.serialize(e,n)),r.push(L),r}},W=new l(2,"("),j=new l(2,")"),D=class extends E{body;left;right;constructor(e,n){super("leftright",e),this.body=n.body,this.left=n.left,this.right=n.right}isOverHigh(){return this.body.isOverHigh()}serialize(e,n){let r=[],t=new l(1,"lr"),{left:a,right:s}=this;return this.head.eq(t)&&(r.push(t),r.push(W)),a&&r.push(a),r.push(...this.body.serialize(e,n)),s&&r.push(s),this.head.eq(t)&&r.push(j),r}},v=class ae extends E{matrix;constructor(n,r){super("matrixLike",n),this.matrix=r}isOverHigh(){return!0}serialize(n,r){let t=[],a,s;if(this.head.eq(ae.MAT)?(a=new l(2,","),s=new l(2,";")):this.head.eq(ae.CASES)?(a=new l(2,"&"),s=new l(2,",")):this.head.eq(l.NONE)&&(a=new l(2,"&"),s=new l(1,"\\")),!this.head.eq(l.NONE)&&(t.push(this.head),n.insideFunctionDepth++,t.push(W),this.options))for(let[i,u]of Object.entries(this.options))t.push(new l(3,`${i}: ${u.toString()}, `));return this.matrix.forEach((i,u)=>{i.forEach((c,h)=>{t.push(...c.serialize(n,r)),h<i.length-1?t.push(a):u<this.matrix.length-1&&t.push(s)})}),this.head.eq(l.NONE)||(t.push(j),n.insideFunctionDepth--),t}static MAT=new l(1,"mat");static CASES=new l(1,"cases")},Ae=class extends E{fragments;constructor(e,n){super("markupFunc",e),this.fragments=n}isOverHigh(){return this.fragments.some(e=>e.isOverHigh())}serialize(e,n){let r=[];if(r.push(this.head),e.insideFunctionDepth++,r.push(W),this.options){let t=Object.entries(this.options);for(let a=0;a<t.length;a++){let[s,i]=t[a];r.push(new l(3,`${s}: ${i.toString()}`)),a<t.length-1&&r.push(new l(2,","))}}r.push(j),r.push(new l(3,"["));for(let t of this.fragments)r.push(new l(3,"$")),r.push(...t.serialize(e,n)),r.push(new l(3,"$"));return r.push(new l(3,"]")),r}},rr=new l(2,"("),tr=new l(2,")"),nr=new l(2,","),fe=new l(1,`
`),X=new l(7," "),ar=class{buffer="";queue=[];options;constructor(e){this.options=e}writeBuffer(e,n){let r=n.toString();if(r==="")return;let t=!1;t||=/[\(\[\|]$/.test(this.buffer)&&/^\w/.test(r),t||=/^[})\]\|]$/.test(r),t||=/[^=]$/.test(this.buffer)&&r==="(",t||=/^[_^,;!]$/.test(r),t||=r==="'",t||=/[\(\[{]\s*(-|\+)$/.test(this.buffer)||this.buffer==="-"||this.buffer==="+",t||=r.startsWith(`
`),t||=this.buffer==="",t||=/\s$/.test(this.buffer)||/^\s/.test(r),t||=this.buffer.endsWith("&")&&r==="=",t||=this.buffer.endsWith("/")||r==="/",t||=n.type===3,t||=/[\s_^{\(]$/.test(this.buffer),e!==null&&(t||=e.type===3),t||(this.buffer+=" "),this.buffer+=r}serialize(e){let n={insideFunctionDepth:0};this.queue.push(...e.serialize(n,this.options))}flushQueue(){let e=[];for(let r of this.queue)r.eq(X)&&e.length>0&&e[e.length-1].eq(X)||e.push(r);let n=new l(1,"");for(let r=0;r<e.length;r++)e[r].eq(X)&&(r===0||r===e.length-1||e[r-1].type===6||e[r-1].isOneOf([rr,fe])||e[r+1].isOneOf([tr,nr,fe]))&&(e[r]=n);e=e.filter(r=>!r.eq(n));for(let r=0;r<e.length;r++){let t=e[r],a=r===0?null:e[r-1];this.writeBuffer(a,t)}this.queue=[]}finalize(){this.flushQueue();let e=function(t){let a=t.replace(/floor\.l\s*(.*?)\s*floor\.r/g,"floor($1)");return a=a.replace(/floor\(\)/g,'floor("")'),a},n=function(t){let a=t.replace(/ceil\.l\s*(.*?)\s*ceil\.r/g,"ceil($1)");return a=a.replace(/ceil\(\)/g,'ceil("")'),a},r=function(t){let a=t.replace(/floor\.l\s*(.*?)\s*ceil\.r/g,"round($1)");return a=a.replace(/round\(\)/g,'round("")'),a};if(this.options.optimize){let t=[e,n,r];for(let a of t)this.buffer=a(this.buffer)}return this.buffer}},_=new Map([["displaystyle","display"],["textstyle","inline"],["hspace","#h"],["|","bar.v.double"],[",","thin"],[":","med"],[" ","med"],[";","thick"],[">","med"],["~","space.nobreak"],["blacktriangleleft","triangle.filled.l"],["blacktriangleright","triangle.filled.r"],["clubsuit","suit.club.filled"],["hookleftarrow","arrow.l.hook"],["hookrightarrow","arrow.r.hook"],["leftrightarrow","arrow.l.r"],["lgblksquare","square.filled.big"],["lgwhtsquare","square.stroked.big"],["nearrow","arrow.tr"],["nwarrow","arrow.tl"],["searrow","arrow.br"],["swarrow","arrow.bl"],["spadesuit","suit.spade.filled"],["updownarrow","arrow.t.b"],["ln","ln"],["log","log"],["cos","cos"],["sin","sin"],["tan","tan"],["cot","cot"],["sec","sec"],["csc","csc"],["mod","mod"],["omicron","omicron"],["Xi","Xi"],["Upsilon","Upsilon"],["lim","lim"],["binom","binom"],["tilde","tilde"],["hat","hat"],["sqrt","sqrt"],["nonumber",""],["vec","arrow"],["neq","eq.not"],["dot","dot"],["ddot","dot.double"],["doteq","dot(eq)"],["dots","dots.h"],["vdots","dots.v"],["ddots","dots.down"],["widehat","hat"],["widetilde","tilde"],["quad","quad"],["qquad","wide"],["overbrace","overbrace"],["underbrace","underbrace"],["overline","overline"],["underline","underline"],["bar","macron"],["dbinom","binom"],["tbinom","binom"],["dfrac","frac"],["tfrac","frac"],["operatorname","op"],["boldsymbol","bold"],["mathbb","bb"],["mathbf","bold"],["mathcal","cal"],["mathscr","scr"],["mathit","italic"],["mathfrak","frak"],["mathrm","upright"],["mathsf","sans"],["mathtt","mono"],["rm","upright"],["pmb","bold"],["leadsto","arrow.r.squiggly"],["P","pilcrow"],["S","section"],["aleph","alef"],["infin","infinity"],["Delta","Delta"],["Gamma","Gamma"],["Lambda","Lambda"],["Omega","Omega"],["Phi","Phi"],["Pi","Pi"],["Psi","Psi"],["Sigma","Sigma"],["Theta","Theta"],["alpha","alpha"],["beta","beta"],["bigcirc","circle.big"],["bullet","bullet"],["cdot","dot.op"],["cdots","dots.c"],["checkmark","checkmark"],["chi","chi"],["circ","circle.small"],["colon","colon"],["cong","tilde.equiv"],["coprod","product.co"],["copyright","copyright"],["cup","union"],["curlyvee","or.curly"],["curlywedge","and.curly"],["dagger","dagger"],["dashv","tack.l"],["ddagger","dagger.double"],["delta","delta"],["ddots","dots.down"],["diamond","diamond"],["div","div"],["divideontimes","times.div"],["dotplus","plus.dot"],["ell","ell"],["emptyset","nothing"],["epsilon","epsilon.alt"],["equiv","equiv"],["eta","eta"],["exists","exists"],["forall","forall"],["gamma","gamma"],["ge","gt.eq"],["geq","gt.eq"],["geqslant","gt.eq.slant"],["gg","gt.double"],["hbar","planck"],["imath","dotless.i"],["iiiint","integral.quad"],["iiint","integral.triple"],["iint","integral.double"],["in","in"],["infty","infinity"],["int","integral"],["intercal","top"],["iota","iota"],["jmath","dotless.j"],["kappa","kappa"],["lambda","lambda"],["land","and"],["langle","chevron.l"],["lbrace","brace.l"],["lbrack","bracket.l"],["ldots","dots.h"],["le","lt.eq"],["leftthreetimes","times.three.l"],["leftrightarrow","arrow.l.r"],["leq","lt.eq"],["leqslant","lt.eq.slant"],["lhd","triangle.l"],["ll","lt.double"],["lor","or"],["ltimes","times.l"],["measuredangle","angle.arc"],["mid","divides"],["models","models"],["mp","minus.plus"],["mu","mu"],["nabla","nabla"],["ncong","tilde.equiv.not"],["ne","eq.not"],["neg","not"],["neq","eq.not"],["nexists","exists.not"],["ni","in.rev"],["nleftarrow","arrow.l.not"],["nleq","lt.eq.not"],["nparallel","parallel.not"],["ngeq","gt.eq.not"],["nmid","divides.not"],["notin","in.not"],["nsim","tilde.not"],["nsubseteq","subset.eq.not"],["nu","nu"],["ntriangleleft","lt.tri.not"],["ntriangleright","gt.tri.not"],["odot","dot.circle"],["oint","integral.cont"],["oiint","integral.surf"],["oiiint","integral.vol"],["omega","omega"],["ominus","minus.circle"],["otimes","times.circle"],["parallel","parallel"],["partial","diff"],["perp","perp"],["phi","phi.alt"],["pi","pi"],["pm","plus.minus"],["pounds","pound"],["prec","prec"],["preceq","prec.eq"],["prime","prime"],["prod","product"],["propto","prop"],["psi","psi"],["rangle","chevron.r"],["rbrace","brace.r"],["rbrack","bracket.r"],["rhd","triangle"],["rho","rho"],["rightarrow","arrow.r"],["rightthreetimes","times.three.r"],["rtimes","times.r"],["setminus","without"],["sigma","sigma"],["sim","tilde.op"],["simeq","tilde.eq"],["slash","slash"],["smallsetminus","without"],["spadesuit","suit.spade"],["sqsubseteq","subset.eq.sq"],["sqsupseteq","supset.eq.sq"],["subset","subset"],["subseteq","subset.eq"],["subsetneq","subset.neq"],["succ","succ"],["succeq","succ.eq"],["sum","sum"],["supset","supset"],["supseteq","supset.eq"],["supsetneq","supset.neq"],["tau","tau"],["theta","theta"],["times","times"],["to","arrow.r"],["top","top"],["triangle","triangle.t"],["twoheadrightarrow","arrow.r.twohead"],["upharpoonright","harpoon.tr"],["uplus","union.plus"],["upsilon","upsilon"],["varepsilon","epsilon"],["varnothing","diameter"],["varphi","phi"],["varpi","pi.alt"],["varrho","rho.alt"],["varsigma","sigma.alt"],["vartheta","theta.alt"],["vdash","tack.r"],["vdots","dots.v"],["vee","or"],["wedge","and"],["wr","wreath"],["xi","xi"],["yen","yen"],["zeta","zeta"],["intop","limits(integral)"],["LaTeX","#LaTeX"],["TeX","#TeX"]]),sr=new Map([["acwopencirclearrow","arrow.ccw"],["adots","dots.up"],["angdnr","angle.acute"],["angle","angle"],["angles","angle.s"],["approx","approx"],["approxeq","approx.eq"],["approxident","tilde.triple"],["assert","tack.r.short"],["ast","ast.op"],["astrosun","sun"],["asymp","asymp"],["awint","integral.ccw"],["backcong","tilde.rev.equiv"],["backdprime","prime.double.rev"],["backprime","prime.rev"],["backsim","tilde.rev"],["backsimeq","tilde.eq.rev"],["backslash","backslash"],["backtrprime","prime.triple.rev"],["bardownharpoonleft","harpoon.bl.bar"],["bardownharpoonright","harpoon.br.bar"],["barleftarrow","arrow.l.stop"],["barleftarrowrightarrowbar","arrows.lr.stop"],["barleftharpoondown","harpoon.lb.stop"],["barleftharpoonup","harpoon.lt.stop"],["barrightharpoondown","harpoon.rb.bar"],["barrightharpoonup","harpoon.rt.bar"],["baruparrow","arrow.t.stop"],["barupharpoonleft","harpoon.tl.stop"],["barupharpoonright","harpoon.tr.stop"],["barV","tack.b.double"],["BbbA","AA"],["BbbB","BB"],["BbbC","CC"],["BbbD","DD"],["BbbE","EE"],["BbbF","FF"],["BbbG","GG"],["BbbH","HH"],["BbbI","II"],["BbbJ","JJ"],["BbbK","KK"],["BbbL","LL"],["BbbM","MM"],["BbbN","NN"],["BbbO","OO"],["BbbP","PP"],["BbbQ","QQ"],["BbbR","RR"],["BbbS","SS"],["BbbT","TT"],["BbbU","UU"],["BbbV","VV"],["BbbW","WW"],["BbbX","XX"],["BbbY","YY"],["BbbZ","ZZ"],["because","because"],["bigblacktriangledown","triangle.filled.b"],["bigblacktriangleup","triangle.filled.t"],["bigbot","tack.t.big"],["bigcap","inter.big"],["bigcup","union.big"],["bigcupdot","union.dot.big"],["biginterleave","interleave.big"],["bigodot","dot.o.big"],["bigoplus","plus.o.big"],["bigotimes","times.o.big"],["bigsqcap","inter.sq.big"],["bigsqcup","union.sq.big"],["bigstar","star.filled"],["bigtimes","times.big"],["bigtop","tack.b.big"],["bigtriangledown","triangle.stroked.b"],["bigtriangleup","triangle.stroked.t"],["biguplus","union.plus.big"],["bigvee","or.big"],["bigwedge","and.big"],["bigwhitestar","star.stroked"],["blackhourglass","hourglass.filled"],["blacktriangle","triangle.filled.small.t"],["blacktriangledown","triangle.filled.small.b"],["blkhorzoval","ellipse.filled.h"],["blkvertoval","ellipse.filled.v"],["bot","bot"],["boxast","ast.square"],["boxdot","dot.square"],["boxminus","minus.square"],["boxplus","plus.square"],["boxtimes","times.square"],["cap","inter"],["Cap","inter.double"],["capdot","inter.dot"],["capwedge","inter.and"],["caretinsert","caret"],["cdot","dot.op"],["cdotp","dot.c"],["checkmark","checkmark"],["circledast","ast.op.o"],["circledbullet","bullet.o"],["circledcirc","compose.o"],["circleddash","dash.o"],["circledequal","cc.nd"],["circledparallel","parallel.o"],["circledvert","bar.v.o"],["circledwhitebullet","bullet.stroked.o"],["Colon","colon.double"],["coloneq","colon.eq"],["Coloneq","colon.double.eq"],["complement","complement"],["cong","tilde.equiv"],["coprod","product.co"],["cup","union"],["Cup","union.double"],["cupdot","union.dot"],["cupleftarrow","union.arrow"],["cupvee","union.or"],["curlyeqprec","eq.prec"],["curlyeqsucc","eq.succ"],["curlyvee","or.curly"],["curlywedge","and.curly"],["curvearrowleft","arrow.ccw.half"],["curvearrowright","arrow.cw.half"],["cwopencirclearrow","arrow.cw"],["dagger","dagger"],["dashcolon","dash.colon"],["dashv","tack.l"],["Dashv","tack.l.double"],["dashVdash","tack.l.r"],["ddagger","dagger.double"],["ddddot","dot.quad"],["dddot","dot.triple"],["ddots","dots.down"],["DDownarrow","arrow.b.quad"],["Ddownarrow","arrow.b.triple"],["diameter","diameter"],["diamondcdot","diamond.stroked.dot"],["diamondsuit","suit.diamond.stroked"],["dicei","die.one"],["diceii","die.two"],["diceiii","die.three"],["diceiv","die.four"],["dicev","die.five"],["dicevi","die.six"],["div","div"],["divideontimes","times.div"],["Doteq","eq.dots"],["dotminus","minus.dot"],["dotplus","plus.dot"],["dotsim","tilde.dot"],["dottedcircle","circle.dotted"],["dottedsquare","square.stroked.dotted"],["doubleplus","plus.double"],["downarrow","arrow.b"],["Downarrow","arrow.b.double"],["downarrowbar","arrow.b.stop"],["downarrowbarred","arrow.b.struck"],["downdasharrow","arrow.b.dashed"],["downdownarrows","arrows.bb"],["downharpoonleft","harpoon.bl"],["downharpoonleftbar","harpoon.bl.stop"],["downharpoonright","harpoon.br"],["downharpoonrightbar","harpoon.br.stop"],["downharpoonsleftright","harpoons.blbr"],["downuparrows","arrows.bt"],["downupharpoonsleftright","harpoons.bltr"],["downwhitearrow","arrow.b.stroked"],["downzigzagarrow","arrow.zigzag"],["dprime","prime.double"],["dualmap","multimap.double"],["eighthnote","note.eighth.alt"],["ell","ell"],["emptysetoarr","emptyset.arrow.r"],["emptysetoarrl","emptyset.arrow.l"],["emptysetobar","emptyset.bar"],["emptysetocirc","emptyset.circle"],["eparsl","parallel.slanted.eq"],["eqcolon","eq.colon"],["eqdef","eq.def"],["eqgtr","eq.gt"],["eqless","eq.lt"],["eqsim","minus.tilde"],["equal","eq"],["equalparallel","parallel.eq"],["equiv","eq.triple"],["Equiv","eq.quad"],["equivVert","parallel.equiv"],["eqvparsl","parallel.slanted.equiv"],["errbarblackcircle","errorbar.circle.filled"],["errbarblackdiamond","errorbar.diamond.filled"],["errbarblacksquare","errorbar.square.filled"],["errbarcircle","errorbar.circle.stroked"],["errbardiamond","errorbar.diamond.stroked"],["errbarsquare","errorbar.square.stroked"],["euro","euro"],["exists","exists"],["fallingdotseq","eq.dots.down"],["fint","integral.slash"],["flat","flat"],["forall","forall"],["fourvdots","fence.dotted"],["frown","frown"],["fullouterjoin","join.l.r"],["geq","gt.eq"],["geqq","gt.equiv"],["geqslant","gt.eq.slant"],["gg","gt.double"],["ggg","gt.triple"],["gggnest","gt.triple.nested"],["gnapprox","gt.napprox"],["gneq","gt.neq"],["gneqq","gt.nequiv"],["gnsim","gt.ntilde"],["greater","gt"],["gtlpar","angle.spheric.rev"],["gtrapprox","gt.approx"],["gtrdot","gt.dot"],["gtreqless","gt.eq.lt"],["gtrless","gt.lt"],["gtrsim","gt.tilde"],["heartsuit","suit.heart.stroked"],["hknearrow","arrow.tr.hook"],["hknwarrow","arrow.tl.hook"],["hksearrow","arrow.br.hook"],["hkswarrow","arrow.bl.hook"],["horizbar","bar.h"],["hourglass","hourglass.stroked"],["hrectangle","rect.stroked.h"],["hrectangleblack","rect.filled.h"],["hyphenbullet","bullet.hyph"],["iiiint","integral.quad"],["iiint","integral.triple"],["iinfin","infinity.incomplete"],["iint","integral.double"],["Im","Im"],["imageof","image"],["in","in"],["increment","laplace"],["infty","infinity"],["int","integral"],["intbar","integral.dash"],["intBar","integral.dash.double"],["intcap","integral.inter"],["intclockwise","integral.cw"],["intcup","integral.union"],["interleave","interleave"],["intlarhk","integral.arrow.hook"],["intx","integral.times"],["inversebullet","bullet.hole"],["Join","join"],["langle","chevron.l"],["lAngle","chevron.l.double"],["langledot","chevron.l.dot"],["lat","lat"],["late","lat.eq"],["lbag","bag.l"],["lblkbrbrak","shell.l.filled"],["lbrace","brace.l"],["lBrace","brace.l.stroked"],["lbrack","bracket.l"],["lBrack","bracket.l.stroked"],["lbracklltick","bracket.l.tick.b"],["lbrackultick","bracket.l.tick.t"],["lbrbrak","shell.l"],["Lbrbrak","shell.l.stroked"],["lceil","ceil.l"],["lcurvyangle","chevron.l.curly"],["leftarrow","arrow.l"],["Leftarrow","arrow.l.double"],["leftarrowtail","arrow.l.tail"],["leftarrowtriangle","arrow.l.open"],["leftdasharrow","arrow.l.dashed"],["leftdotarrow","arrow.l.dotted"],["leftdowncurvedarrow","arrow.l.curve"],["leftharpoondown","harpoon.lb"],["leftharpoondownbar","harpoon.lb.bar"],["leftharpoonsupdown","harpoons.ltlb"],["leftharpoonup","harpoon.lt"],["leftharpoonupbar","harpoon.lt.bar"],["leftleftarrows","arrows.ll"],["leftouterjoin","join.l"],["Leftrightarrow","arrow.l.r.double"],["leftrightarrows","arrows.lr"],["leftrightarrowtriangle","arrow.l.r.open"],["leftrightharpoondowndown","harpoon.lb.rb"],["leftrightharpoondownup","harpoon.lb.rt"],["leftrightharpoons","harpoons.ltrb"],["leftrightharpoonsdown","harpoons.lbrb"],["leftrightharpoonsup","harpoons.ltrt"],["leftrightharpoonupdown","harpoon.lt.rb"],["leftrightharpoonupup","harpoon.lt.rt"],["leftrightsquigarrow","arrow.l.r.wave"],["leftsquigarrow","arrow.l.squiggly"],["leftthreearrows","arrows.lll"],["leftthreetimes","times.three.l"],["leftwavearrow","arrow.l.wave"],["leftwhitearrow","arrow.l.stroked"],["leq","lt.eq"],["leqq","lt.equiv"],["leqslant","lt.eq.slant"],["less","lt"],["lessapprox","lt.approx"],["lessdot","lt.dot"],["lesseqgtr","lt.eq.gt"],["lessgtr","lt.gt"],["lesssim","lt.tilde"],["lfloor","floor.l"],["lgblkcircle","circle.filled.big"],["lgroup","paren.l.flat"],["lgwhtcircle","circle.stroked.big"],["ll","lt.double"],["llangle","chevron.l.closed"],["llblacktriangle","triangle.filled.bl"],["llcorner","corner.l.b"],["LLeftarrow","arrow.l.quad"],["Lleftarrow","arrow.l.triple"],["lll","lt.triple"],["lllnest","lt.triple.nested"],["llparenthesis","paren.l.closed"],["lltriangle","triangle.stroked.bl"],["lmoustache","mustache.l"],["lnapprox","lt.napprox"],["lneq","lt.neq"],["lneqq","lt.nequiv"],["lnsim","lt.ntilde"],["longdashv","tack.l.long"],["Longleftarrow","arrow.l.double.long"],["longleftarrow","arrow.l.long"],["Longleftrightarrow","arrow.l.r.double.long"],["longleftrightarrow","arrow.l.r.long"],["longleftsquigarrow","arrow.l.long.squiggly"],["Longmapsfrom","arrow.l.double.long.bar"],["longmapsfrom","arrow.l.long.bar"],["longmapsto","arrow.r.long.bar"],["Longmapsto","arrow.r.double.long.bar"],["Longrightarrow","arrow.r.double.long"],["longrightarrow","arrow.r.long"],["longrightsquigarrow","arrow.r.long.squiggly"],["looparrowleft","arrow.l.loop"],["looparrowright","arrow.r.loop"],["lparen","paren.l"],["lParen","paren.l.stroked"],["lrblacktriangle","triangle.filled.br"],["lrcorner","corner.r.b"],["lrtriangle","triangle.stroked.br"],["ltimes","times.l"],["lvzigzag","fence.l"],["Lvzigzag","fence.l.double"],["maltese","maltese"],["mapsdown","arrow.b.bar"],["mapsfrom","arrow.l.bar"],["Mapsfrom","arrow.l.double.bar"],["mapsto","arrow.r.bar"],["Mapsto","arrow.r.double.bar"],["mapsup","arrow.t.bar"],["mathampersand","amp"],["mathatsign","at"],["mathcolon","colon"],["mathcomma","comma"],["mathdollar","dollar"],["mathexclam","excl"],["mathhyphen","hyph"],["mathparagraph","pilcrow"],["mathpercent","percent"],["mathperiod","dot.basic"],["mathplus","plus"],["mathquestion","quest"],["mathratio","ratio"],["mathsection","section"],["mathsemicolon","semi"],["mathslash","slash"],["mathsterling","pound"],["mathyen","yen"],["mdblkdiamond","diamond.filled.medium"],["mdblklozenge","lozenge.filled.medium"],["mdlgblkcircle","circle.filled"],["mdlgblkdiamond","diamond.filled"],["mdlgblklozenge","lozenge.filled"],["mdlgblksquare","square.filled"],["mdlgwhtcircle","circle.stroked"],["mdlgwhtdiamond","diamond.stroked"],["mdlgwhtlozenge","lozenge.stroked"],["mdlgwhtsquare","square.stroked"],["mdsmblkcircle","circle.filled.tiny"],["mdsmwhtcircle","circle.stroked.small"],["mdwhtdiamond","diamond.stroked.medium"],["mdwhtlozenge","lozenge.stroked.medium"],["measeq","eq.m"],["measuredangle","angle.arc"],["measuredangleleft","angle.arc.rev"],["measuredrightangle","angle.right.arc"],["mho","Omega.inv"],["mid","divides"],["minus","minus"],["models","models"],["mp","minus.plus"],["multimap","multimap"],["nabla","gradient"],["napprox","approx.not"],["nasymp","asymp.not"],["natural","natural"],["ncong","tilde.equiv.not"],["ne","eq.not"],["Nearrow","arrow.tr.double"],["neg","not"],["nequiv","equiv.not"],["neswarrow","arrow.tr.bl"],["nexists","exists.not"],["ngeq","gt.eq.not"],["ngtr","gt.not"],["ngtrless","gt.lt.not"],["ngtrsim","gt.tilde.not"],["nHdownarrow","arrow.b.dstruck"],["nhpar","parallel.struck"],["nHuparrow","arrow.t.dstruck"],["nhVvert","interleave.struck"],["ni","in.rev"],["nLeftarrow","arrow.l.double.not"],["nleftarrow","arrow.l.not"],["nLeftrightarrow","arrow.l.r.double.not"],["nleftrightarrow","arrow.l.r.not"],["nleq","lt.eq.not"],["nless","lt.not"],["nlessgtr","lt.gt.not"],["nlesssim","lt.tilde.not"],["nmid","divides.not"],["nni","in.rev.not"],["notin","in.not"],["nparallel","parallel.not"],["nprec","prec.not"],["npreccurlyeq","prec.curly.eq.not"],["nRightarrow","arrow.r.double.not"],["nrightarrow","arrow.r.not"],["nsim","tilde.not"],["nsimeq","tilde.eq.not"],["nsqsubseteq","subset.eq.sq.not"],["nsqsupseteq","supset.eq.sq.not"],["nsubset","subset.not"],["nsubseteq","subset.eq.not"],["nsucc","succ.not"],["nsucccurlyeq","succ.curly.eq.not"],["nsupset","supset.not"],["nsupseteq","supset.eq.not"],["ntrianglelefteq","lt.tri.eq.not"],["ntrianglerighteq","gt.tri.eq.not"],["nvartriangleleft","lt.tri.not"],["nvartriangleright","gt.tri.not"],["nVdash","forces.not"],["nvdash","tack.r.not"],["nvDash","tack.r.double.not"],["nvinfty","infinity.bar"],["nvLeftarrow","arrow.l.double.struck"],["nvleftarrow","arrow.l.struck"],["nVleftarrow","arrow.l.dstruck"],["nvleftarrowtail","arrow.l.tail.struck"],["nVleftarrowtail","arrow.l.tail.dstruck"],["nvLeftrightarrow","arrow.l.r.double.struck"],["nvleftrightarrow","arrow.l.r.struck"],["nVleftrightarrow","arrow.l.r.dstruck"],["nvRightarrow","arrow.r.double.struck"],["nvrightarrow","arrow.r.struck"],["nVrightarrow","arrow.r.dstruck"],["nvrightarrowtail","arrow.r.tail.struck"],["nVrightarrowtail","arrow.r.tail.dstruck"],["nvtwoheadleftarrow","arrow.l.twohead.struck"],["nVtwoheadleftarrow","arrow.l.twohead.dstruck"],["nvtwoheadleftarrowtail","arrow.l.twohead.tail.struck"],["nVtwoheadleftarrowtail","arrow.l.twohead.tail.dstruck"],["nvtwoheadrightarrow","arrow.r.twohead.struck"],["nVtwoheadrightarrow","arrow.r.twohead.dstruck"],["nvtwoheadrightarrowtail","arrow.r.twohead.tail.struck"],["nVtwoheadrightarrowtail","arrow.r.twohead.tail.dstruck"],["Nwarrow","arrow.tl.double"],["nwsearrow","arrow.tl.br"],["obrbrak","shell.t"],["obslash","backslash.o"],["odiv","div.o"],["odot","dot.o"],["odotslashdot","div.slanted.o"],["ogreaterthan","gt.o"],["oiiint","integral.vol"],["oiint","integral.surf"],["oint","integral.cont"],["ointctrclockwise","integral.cont.ccw"],["olessthan","lt.o"],["ominus","minus.o"],["operp","perp.o"],["oplus","plus.o"],["opluslhrim","plus.o.l"],["oplusrhrim","plus.o.r"],["origof","original"],["oslash","slash.o"],["otimes","times.o"],["otimeshat","times.o.hat"],["otimeslhrim","times.o.l"],["otimesrhrim","times.o.r"],["parallel","parallel"],["parallelogram","parallelogram.stroked"],["parallelogramblack","parallelogram.filled"],["parsim","parallel.tilde"],["partial","partial"],["pentagon","penta.stroked"],["pentagonblack","penta.filled"],["perp","perp"],["pm","plus.minus"],["prec","prec"],["Prec","prec.double"],["precapprox","prec.approx"],["preccurlyeq","prec.curly.eq"],["preceq","prec.eq"],["preceqq","prec.equiv"],["precnapprox","prec.napprox"],["precneq","prec.neq"],["precneqq","prec.nequiv"],["precnsim","prec.ntilde"],["precsim","prec.tilde"],["prime","prime"],["prod","product"],["propto","prop"],["QED","qed"],["qprime","prime.quad"],["quarternote","note.quarter.alt"],["questeq","eq.quest"],["Question","quest.double"],["rangle","chevron.r"],["rAngle","chevron.r.double"],["rangledot","chevron.r.dot"],["rangledownzigzagarrow","angle.azimuth"],["rbag","bag.r"],["rblkbrbrak","shell.r.filled"],["rbrace","brace.r"],["rBrace","brace.r.stroked"],["rbrack","bracket.r"],["rBrack","bracket.r.stroked"],["rbracklrtick","bracket.r.tick.b"],["rbrackurtick","bracket.r.tick.t"],["rbrbrak","shell.r"],["Rbrbrak","shell.r.stroked"],["rceil","ceil.r"],["rcurvyangle","chevron.r.curly"],["Re","Re"],["revangle","angle.rev"],["revemptyset","emptyset.rev"],["revnmid","divides.not.rev"],["rfloor","floor.r"],["rgroup","paren.r.flat"],["rightangle","angle.right"],["rightanglemdot","angle.right.dot"],["rightanglesqr","angle.right.square"],["rightarrow","arrow.r"],["Rightarrow","arrow.r.double"],["rightarrowbar","arrow.r.stop"],["rightarrowonoplus","plus.o.arrow"],["rightarrowtail","arrow.r.tail"],["rightarrowtriangle","arrow.r.open"],["rightdasharrow","arrow.r.dashed"],["rightdotarrow","arrow.r.dotted"],["rightdowncurvedarrow","arrow.r.curve"],["rightharpoondown","harpoon.rb"],["rightharpoondownbar","harpoon.rb.stop"],["rightharpoonsupdown","harpoons.rtrb"],["rightharpoonup","harpoon.rt"],["rightharpoonupbar","harpoon.rt.stop"],["rightleftarrows","arrows.rl"],["rightleftharpoons","harpoons.rtlb"],["rightleftharpoonsdown","harpoons.rblb"],["rightleftharpoonsup","harpoons.rtlt"],["rightouterjoin","join.r"],["rightrightarrows","arrows.rr"],["rightsquigarrow","arrow.r.squiggly"],["rightthreearrows","arrows.rrr"],["rightthreetimes","times.three.r"],["rightwavearrow","arrow.r.wave"],["rightwhitearrow","arrow.r.stroked"],["risingdotseq","eq.dots.up"],["rmoustache","mustache.r"],["rparen","paren.r"],["rParen","paren.r.stroked"],["rrangle","chevron.r.closed"],["RRightarrow","arrow.r.quad"],["Rrightarrow","arrow.r.triple"],["rrparenthesis","paren.r.closed"],["rsolbar","backslash.not"],["rtimes","times.r"],["rvzigzag","fence.r"],["Rvzigzag","fence.r.double"],["Searrow","arrow.br.double"],["setminus","without"],["sharp","sharp"],["shortdowntack","tack.b.short"],["shortlefttack","tack.l.short"],["shortuptack","tack.t.short"],["sim","tilde.op"],["sime","tilde.eq"],["similarleftarrow","arrow.l.tilde"],["similarrightarrow","arrow.r.tilde"],["simneqq","tilde.nequiv"],["smallblacktriangleleft","triangle.filled.small.l"],["smallblacktriangleright","triangle.filled.small.r"],["smallin","in.small"],["smallni","in.rev.small"],["smalltriangleleft","triangle.stroked.small.l"],["smalltriangleright","triangle.stroked.small.r"],["smashtimes","smash"],["smblkcircle","bullet"],["smblkdiamond","diamond.filled.small"],["smblklozenge","lozenge.filled.small"],["smeparsl","parallel.slanted.eq.tilde"],["smile","smile"],["smt","smt"],["smte","smt.eq"],["smwhtcircle","bullet.stroked"],["smwhtdiamond","diamond.stroked.small"],["smwhtlozenge","lozenge.stroked.small"],["sphericalangle","angle.spheric"],["sphericalangleup","angle.spheric.t"],["sqcap","inter.sq"],["Sqcap","inter.sq.double"],["sqcup","union.sq"],["Sqcup","union.sq.double"],["sqint","integral.square"],["sqsubset","subset.sq"],["sqsubseteq","subset.eq.sq"],["sqsubsetneq","subset.sq.neq"],["sqsupset","supset.sq"],["sqsupseteq","supset.eq.sq"],["sqsupsetneq","supset.sq.neq"],["squoval","square.stroked.rounded"],["sslash","slash.double"],["star","star.op"],["stareq","eq.star"],["subset","subset"],["Subset","subset.double"],["subsetdot","subset.dot"],["subseteq","subset.eq"],["subsetneq","subset.neq"],["succ","succ"],["Succ","succ.double"],["succapprox","succ.approx"],["succcurlyeq","succ.curly.eq"],["succeq","succ.eq"],["succeqq","succ.equiv"],["succnapprox","succ.napprox"],["succneq","succ.neq"],["succneqq","succ.nequiv"],["succnsim","succ.ntilde"],["succsim","succ.tilde"],["sum","sum"],["sumint","sum.integral"],["supset","supset"],["Supset","supset.double"],["supsetdot","supset.dot"],["supseteq","supset.eq"],["supsetneq","supset.neq"],["Swarrow","arrow.bl.double"],["therefore","therefore"],["threedangle","angle.spatial"],["threedotcolon","colon.tri.op"],["tieinfty","infinity.tie"],["times","times"],["tminus","miny"],["top","tack.b"],["tplus","tiny"],["trianglecdot","triangle.stroked.dot"],["triangledown","triangle.stroked.small.b"],["triangleleft","triangle.stroked.l"],["trianglelefteq","lt.tri.eq"],["triangleminus","minus.triangle"],["triangleplus","plus.triangle"],["triangleq","eq.delta"],["triangleright","triangle.stroked.r"],["trianglerighteq","gt.tri.eq"],["triangletimes","times.triangle"],["tripleplus","plus.triple"],["trprime","prime.triple"],["trslash","slash.triple"],["turnediota","iota.inv"],["twoheaddownarrow","arrow.b.twohead"],["twoheadleftarrow","arrow.l.twohead"],["twoheadleftarrowtail","arrow.l.twohead.tail"],["twoheadmapsfrom","arrow.l.twohead.bar"],["twoheadmapsto","arrow.r.twohead.bar"],["twoheadrightarrow","arrow.r.twohead"],["twoheadrightarrowtail","arrow.r.twohead.tail"],["twoheaduparrow","arrow.t.twohead"],["twonotes","note.eighth.beamed"],["ubrbrak","shell.b"],["ulblacktriangle","triangle.filled.tl"],["ulcorner","corner.l.t"],["ultriangle","triangle.stroked.tl"],["uminus","union.minus"],["underbrace","brace.b"],["underbracket","bracket.b"],["underparen","paren.b"],["unicodecdots","dots.h.c"],["unicodeellipsis","dots.h"],["upand","amp.inv"],["uparrow","arrow.t"],["Uparrow","arrow.t.double"],["uparrowbarred","arrow.t.struck"],["upbackepsilon","epsilon.alt.rev"],["updasharrow","arrow.t.dashed"],["upDigamma","Digamma"],["updigamma","digamma"],["Updownarrow","arrow.t.b.double"],["updownarrows","arrows.tb"],["updownharpoonleftleft","harpoon.tl.bl"],["updownharpoonleftright","harpoon.tl.br"],["updownharpoonrightleft","harpoon.tr.bl"],["updownharpoonrightright","harpoon.tr.br"],["updownharpoonsleftright","harpoons.tlbr"],["upharpoonleft","harpoon.tl"],["upharpoonleftbar","harpoon.tl.bar"],["upharpoonright","harpoon.tr"],["upharpoonrightbar","harpoon.tr.bar"],["upharpoonsleftright","harpoons.tltr"],["uplus","union.plus"],["upuparrows","arrows.tt"],["upwhitearrow","arrow.t.stroked"],["urblacktriangle","triangle.filled.tr"],["urcorner","corner.r.t"],["urtriangle","triangle.stroked.tr"],["UUparrow","arrow.t.quad"],["Uuparrow","arrow.t.triple"],["varclubsuit","suit.club.stroked"],["varhexagon","hexa.stroked"],["varhexagonblack","hexa.filled"],["varnothing","emptyset"],["varointclockwise","integral.cont.cw"],["varspadesuit","suit.spade.stroked"],["vartriangle","triangle.stroked.small.t"],["vartriangleleft","lt.tri"],["vartriangleright","gt.tri"],["Vbar","tack.t.double"],["Vdash","forces"],["vdash","tack.r"],["vDash","tack.r.double"],["vdots","dots.v"],["vee","or"],["Vee","or.double"],["veedot","or.dot"],["veeeq","eq.equi"],["vert","bar.v"],["Vert","bar.v.double"],["vlongdash","tack.r.long"],["vrectangle","rect.stroked.v"],["vrectangleblack","rect.filled.v"],["Vvert","bar.v.triple"],["vysmblkcircle","circle.filled.small"],["vysmwhtcircle","circle.stroked.tiny"],["wedge","and"],["Wedge","and.double"],["wedgedot","and.dot"],["wedgeq","eq.est"],["whiteinwhitetriangle","triangle.stroked.nested"],["whthorzoval","ellipse.stroked.h"],["whtvertoval","ellipse.stroked.v"],["wideangledown","angle.obtuse"],["wr","wreath"],["xsol","slash.big"]]),lr=new Map([["gets","leftarrow"],["iff","Longleftrightarrow"],["implies","Longrightarrow"]]);for(let[e,n]of sr)_.has(e)||_.set(e,n);var R=new Map;for(let[e,n]of Array.from(_.entries()).reverse())R.set(n,e);R.set("oo","infty");var ir=new Map([["top","top"],["frac","frac"],["tilde","tilde"],["hat","hat"],["upright","mathrm"],["bold","boldsymbol"],["infinity","infty"]]);for(let[e,n]of ir)R.set(e,n);for(let[e,n]of lr)_.has(e)||_.set(e,_.get(n));var I=class extends Error{node;constructor(e,n=null){super(e),this.name="ConverterError",this.node=n}},or=l.NONE.toNode(),ur=["dim","id","im","mod","Pr","sech","csch"];function cr(e){if(/^[a-zA-Z0-9]$/.test(e))return e;if(e==="/")return"\\/";if(["\\\\","\\{","\\}","\\%"].includes(e))return e.substring(1);if(["\\$","\\#","\\&","\\_"].includes(e))return e;if(e.startsWith("\\")){let n=e.slice(1);return _.has(n)?_.get(n):null}return e}function k(e,n){let r;switch(e.type){case 0:return l.NONE;case 2:r=1;break;case 1:r=2;break;case 3:r=3;break;case 4:r=5;break;case 5:r=6;break;case 6:r=8;break;case 7:{if(e.value==="\\\\")return new l(7,"\\");if(e.value==="\\!")return new l(1,"#h(-math.thin.amount)");if(e.value==="~"){let a=_.get("~");return new l(1,a)}else if(_.has(e.value.substring(1))){let a=_.get(e.value.substring(1));return new l(1,a)}else throw new Error(`Unknown control sequence: ${e.value}`)}default:throw Error(`Unknown token type: ${e.type}`)}let t=cr(e.value);if(t===null){if(n.nonStrict)return new l(r,e.value.substring(1));throw new I(`Unknown token: ${e.value}`,e)}return new l(r,t)}function hr(e,n){let[r,t]=e.args;if(n.optimize&&["\\overset{\\text{def}}{=}","\\overset{d e f}{=}"].includes(e.toString()))return new l(1,"eq.def").toNode();let a=new b(new l(1,"limits"),[g(t,n)]);return new G({base:a,sup:g(r,n),sub:null})}function pr(e,n){let[r,t]=e.args,a=new b(new l(1,"limits"),[g(t,n)]);return new G({base:a,sub:g(r,n),sup:null})}function dr(e){let n={},r={l:"#left",c:"#center",r:"#right"},t=Array.from(e),a=[],s=0;for(let u of t)u==="|"?a.push(s):(u==="l"||u==="c"||u==="r")&&s++;if(a.length>0){let u;a.length===1?u=`#${a[0]}`:u=`#(vline: (${a.join(", ")}))`,n.augment=new l(3,u).toNode()}let i=t.map(u=>r[u]).filter(u=>u!==void 0).map(u=>new l(3,u).toNode());if(i.length>0){let u=i.every(c=>c.eq(i[0]));n.align=u?i[0]:new l(3,"#center").toNode()}return n}var wr=new l(2,"("),gr=new l(2,")");function K(e){return["group","supsub","matrixLike","fraction","empty"].includes(e.type)?new D(null,{left:wr,right:gr,body:e}):e}function g(e,n){switch(e.type){case"terminal":return k(e.head,n).toNode();case"text":{let t=e;return new l(4,t.head.value).toNode()}case"ordgroup":let r=e;return new z(r.items.map(t=>g(t,n)));case"supsub":{let t=e,{base:a,sup:s,sub:i}=t;if(a&&a.type==="funcCall"&&a.head.value==="\\overbrace"&&s)return new b(new l(1,"overbrace"),[g(a.args[0],n),g(s,n)]);if(a&&a.type==="funcCall"&&a.head.value==="\\underbrace"&&i)return new b(new l(1,"underbrace"),[g(a.args[0],n),g(i,n)]);let u={base:g(a,n),sup:s?g(s,n):null,sub:i?g(i,n):null};return u.sup&&(u.sup=K(u.sup)),u.sub&&(u.sub=K(u.sub)),new G(u)}case"leftright":{let t=e,{left:a,right:s}=t,i=g(t.body,n);if(n.optimize&&a!==null&&s!==null){let p=k(a,n),y=k(s,n);if(a.value==="\\|"&&s.value==="\\|")return new b(new l(1,"norm"),[i]);if(["[]","()","\\{\\}","\\lfloor\\rfloor","\\lceil\\rceil","\\lfloor\\rceil"].includes(a.value+s.value))return new z([p.toNode(),i,y.toNode()])}let u=function(p){return["(",")","{","["].includes(p.value)?new l(2,"\\"+p.value):p},c=a?k(a,n):null,h=s?k(s,n):null;return c===null&&h!==null&&(h=u(h)),h===null&&c!==null&&(c=u(c)),new D(new l(1,"lr"),{body:i,left:c,right:h})}case"funcCall":{let t=e,a=g(t.args[0],n);if(t.head.value==="\\sqrt"&&t.data){let s=g(t.data,n);return new b(new l(1,"root"),[s,a])}if(t.head.value==="\\mathbf"){let s=new b(new l(1,"bold"),[a]);return new b(new l(1,"upright"),[s])}if(t.head.value==="\\overrightarrow")return new b(new l(1,"arrow"),[a]);if(t.head.value==="\\overleftarrow")return new b(new l(1,"accent"),[a,new l(1,"arrow.l").toNode()]);if(t.head.value==="\\operatorname")return n.optimize&&ur.includes(a.head.value)?new l(1,a.head.value).toNode():new b(new l(1,"op"),[new l(4,a.head.value).toNode()]);if(t.head.value==="\\textcolor"){let s=new Ae(new l(1,"#text"),[g(t.args[1],n)]);return s.setOptions({fill:a}),s}if(t.head.value==="\\substack"||t.head.value==="\\displaylines"||t.head.value==="\\mathinner")return a;if(t.head.value==="\\mathrel")return new b(new l(1,"class"),[new l(4,"relation").toNode(),a]);if(t.head.value==="\\mathbin")return new b(new l(1,"class"),[new l(4,"binary").toNode(),a]);if(t.head.value==="\\mathop")return new b(new l(1,"class"),[new l(4,"large").toNode(),a]);if(t.head.value==="\\set")return new D(null,{body:a,left:l.LEFT_BRACE,right:l.RIGHT_BRACE});if(t.head.value==="\\not"){let s=g(t.args[0],n);if(d(s.type==="terminal"),s.head.type===1)return new l(1,s.head.value+".not").toNode();switch(s.head.value){case"=":return new l(1,"eq.not").toNode();default:throw new Error(`Not supported: \\not ${s.head.value}`)}}if(t.head.value==="\\overset")return hr(t,n);if(t.head.value==="\\underset")return pr(t,n);if(t.head.value==="\\frac"&&n.fracToSlash)return new Ne(t.args.map(s=>g(s,n)).map(K));if(n.optimize){if(t.head.value==="\\mathbb"&&/^\\mathbb{[A-Z]}$/.test(t.toString()))return new l(1,a.head.value.repeat(2)).toNode();if(t.head.value==="\\mathrm"&&t.toString()==="\\mathrm{d}")return new l(1,"dif").toNode()}return new b(k(t.head,n),t.args.map(s=>g(s,n)))}case"beginend":{let t=e,a=t.matrix.map(s=>s.map(i=>g(i,n)));if(t.head.value.startsWith("align"))return new v(null,a);if(t.head.value==="cases")return new v(v.CASES,a);if(t.head.value==="subarray"){if(t.data)switch(t.data.head.value){case"r":a.forEach(i=>i.push(l.EMPTY.toNode()));break;case"l":a.forEach(i=>i.unshift(l.EMPTY.toNode()));break;default:break}return new v(null,a)}if(t.head.value==="array"){let s={delim:or};d(t.data!==null&&t.head.type===3);let i=dr(t.data.head.value);Object.assign(s,i);let u=new v(v.MAT,a);return u.setOptions(s),u}if(t.head.value.endsWith("matrix")){let s=new v(v.MAT,a),i;switch(t.head.value){case"matrix":i=l.NONE;break;case"pmatrix":return s;case"bmatrix":i=new l(4,"[");break;case"Bmatrix":i=new l(4,"{");break;case"vmatrix":i=new l(4,"|");break;case"Vmatrix":{i=new l(1,"bar.v.double");break}default:throw new I(`Unimplemented beginend: ${t.head}`,t)}return s.setOptions({delim:i.toNode()}),s}throw new I(`Unimplemented beginend: ${t.head}`,t)}default:throw new I(`Unimplemented node type: ${e.type}`,e)}}function S(e){switch(e.type){case 0:return o.EMPTY;case 1:{let n=function(r){switch(r){case"eq":return"=";case"plus":return"+";case"minus":return"-";case"percent":return"%";default:return R.has(r)?"\\"+R.get(r):"\\"+r}};if(e.value.endsWith(".not")){let r=n(e.value.slice(0,-4));return new o(2,r.startsWith("\\")?`\\not${r}`:`\\not ${r}`)}return new o(2,n(e.value))}case 2:{let n;return["{","}","%"].includes(e.value)?n="\\"+e.value:n=e.value,new o(1,n)}case 3:return new o(3,e.value);case 4:return new o(3,e.value);case 5:return new o(4,e.value);case 6:return new o(5,e.value);case 7:{let n;switch(e.value){case"\\":n="\\\\";break;case"&":n="&";break;default:throw new Error(`[typst_token_to_tex]Unimplemented control sequence: ${e.value}`)}return new o(7,n)}case 8:return new o(6,e.value);default:throw new Error(`Unimplemented token type: ${e.type}`)}}var fr=new o(1,",").toNode();function Me(e,n){let r=t=>Me(t,n);switch(e.type){case"terminal":{let t=e;if(t.head.type===1){if(t.head.value==="eq.def")return new m(new o(2,"\\overset"),[new H(new o(3,"def")),new o(1,"=").toNode()]);if(t.head.value==="comma")return new o(1,",").toNode();if(t.head.value==="dif")return new m(new o(2,"\\mathrm"),[new o(1,"d").toNode()]);if(t.head.value==="hyph"||t.head.value==="hyph.minus")return new H(new o(3,"-"));if(/^([A-Z])\1$/.test(t.head.value))return new m(new o(2,"\\mathbb"),[new o(1,t.head.value[0]).toNode()])}return t.head.type===4?new H(new o(3,t.head.value)):S(t.head).toNode()}case"group":{let a=e.items.map(r),s=new o(7,"&").toNode(),i=new o(7,"\\\\").toNode();if(xe(a,s)){let u=Y(a,i),c=[];for(let h of u){let p=Y(h,s);c.push(p.map(y=>new q(y)))}return new O(new o(3,"aligned"),c)}return new q(a)}case"leftright":{let t=e,a=r(t.body),s=t.left?S(t.left):new o(1,"."),i=t.right?S(t.right):new o(1,".");return t.isOverHigh()&&(s.value="\\left"+s.value,i.value="\\right"+i.value),new q([s.toNode(),a,i.toNode()])}case"funcCall":{let t=e;switch(t.head.value){case"norm":{let a=t.args[0],s=r(a);return t.isOverHigh()?new ee({body:s,left:new o(2,"\\|"),right:new o(2,"\\|")}):s}case"floor":case"ceil":{let a="\\l"+t.head.value,s="\\r"+t.head.value,i=t.args[0],u=r(i),c=new o(2,a),h=new o(2,s);return t.isOverHigh()?new ee({body:u,left:c,right:h}):new q([c.toNode(),u,h.toNode()])}case"root":{let[a,s]=t.args,i=r(a);return new m(new o(2,"\\sqrt"),[r(s)],i)}case"overbrace":case"underbrace":{let[a,s]=t.args,i=new m(S(t.head),[r(a)]),u=r(s),c=t.head.value==="overbrace"?{base:i,sup:u,sub:null}:{base:i,sub:u,sup:null};return new J(c)}case"vec":{let a=t.args.map(s=>[r(s)]);return new O(new o(3,"pmatrix"),a)}case"op":{let a=t.args[0];return d(a.head.type===4),new m(S(t.head),[new o(3,a.head.value).toNode()])}case"class":{let a=t.args[0];d(a.head.type===4);let s;switch(a.head.value){case"relation":s="\\mathrel";break;case"binary":s="\\mathbin";break;case"large":s="\\mathop";break;default:throw new Error(`Unimplemented class: ${a.head.value}`)}return new m(new o(2,s),[r(t.args[1])])}case"display":{let a=t.args[0],s=new q([o.COMMAND_DISPLAYSTYLE.toNode(),r(a)]);return n.blockMathMode||s.items.push(o.COMMAND_TEXTSTYLE.toNode()),s}case"inline":{let a=t.args[0],s=new q([o.COMMAND_TEXTSTYLE.toNode(),r(a)]);return n.blockMathMode&&s.items.push(o.COMMAND_DISPLAYSTYLE.toNode()),s}default:{let a=S(t.head),s=le.includes(a.value.substring(1))||ie.includes(a.value.substring(1));return a.value.length>0&&s?new m(a,t.args.map(r)):new q([S(t.head).toNode(),new o(1,"(").toNode(),...Ue(t.args.map(r),fr),new o(1,")").toNode()])}}}case"markupFunc":{let t=e;switch(t.head.value){case"#text":if(t.options&&t.options.fill){let a=t.options.fill;return new m(new o(2,"\\textcolor"),[r(a),r(t.fragments[0])])}case"#heading":default:throw new Error(`Unimplemented markup function: ${t.head.value}`)}}case"supsub":{let t=e,{base:a,sup:s,sub:i}=t,u=s?r(s):null,c=i?r(i):null;if(a.head.eq(new l(1,"limits"))){let N=r(a.args[0]);if(u!==null&&c===null)return new m(new o(2,"\\overset"),[u,N]);if(u===null&&c!==null)return new m(new o(2,"\\underset"),[c,N]);{let ue=new m(new o(2,"\\underset"),[c,N]);return new m(new o(2,"\\overset"),[u,ue])}}let h=r(a);return new J({base:h,sup:u,sub:c})}case"matrixLike":{let t=e,a=t.matrix.map(s=>s.map(r));if(t.head.eq(v.MAT)){let s="pmatrix";if(t.options&&"delim"in t.options){let i=t.options.delim;switch(i.head.value){case"#none":s="matrix";break;case"[":case"]":s="bmatrix";break;case"(":case")":s="pmatrix";break;case"{":case"}":s="Bmatrix";break;case"|":s="vmatrix";break;case"bar":case"bar.v":s="vmatrix";break;case"bar.v.double":s="Vmatrix";break;default:throw new Error(`Unexpected delimiter ${i.head}`)}}return new O(new o(3,s),a)}else{if(t.head.eq(v.CASES))return new O(new o(3,"cases"),a);throw new Error(`Unexpected matrix type ${t.head}`)}}case"fraction":{let t=e,[a,s]=t.args,i=r(a),u=r(s);return new m(new o(2,"\\frac"),[i,u])}default:throw new Error("[convert_typst_node_to_tex] Unimplemented type: "+e.type)}}var mr=Array.from(oe.keys());function br(){return`(${mr.map(n=>(n=n.replaceAll("|","\\|"),n=n.replaceAll(".","\\."),n=n.replaceAll("[","\\["),n=n.replaceAll("]","\\]"),n)).join("|")})`}var vr=br(),qr=new Map([[String.raw`//[^\n]*`,e=>new l(5,e.text().substring(2))],[String.raw`/`,e=>new l(2,e.text())],[String.raw`[_^&]`,e=>new l(7,e.text())],[String.raw`\r?\n`,e=>new l(8,`
`)],[String.raw`\s+`,e=>new l(6,e.text())],[String.raw`\\[$&#_]`,e=>new l(2,e.text())],[String.raw`\\\n`,e=>[new l(7,"\\"),new l(8,`
`)]],[String.raw`\\\s`,e=>[new l(7,"\\"),new l(6," ")]],[String.raw`\\\S`,e=>new l(7,"")],[String.raw`"([^"]|(\\"))*"`,e=>{let n=e.text().substring(1,e.text().length-1);return n.replaceAll('\\"','"'),new l(4,n)}],[vr,e=>{let n=e.text(),r=oe.get(n);return new l(1,r)}],[String.raw`[0-9]+(\.[0-9]+)?`,e=>new l(2,e.text())],[String.raw`[+\-*/=\'<>!.,;?()\[\]|]`,e=>new l(2,e.text())],[String.raw`#h\((.+?)\)`,e=>{let n=e.reMatchArray();return[new l(1,"#h"),new l(2,"("),new l(3,n[1]),new l(2,")")]}],[String.raw`#none`,e=>new l(0,e.text())],[String.raw`#?[a-zA-Z\.]+`,e=>new l(e.text().length===1?2:1,e.text())],[String.raw`.`,e=>new l(2,e.text())]]),_r={start:qr};function yr(e){return new Se(_r).collect(e)}function me(e,n){let r=n;for(;r<e.length&&e[r].eq(new l(2,"'"));)r+=1;return r-n}function Oe(e,n,r,t){d(e[n].isOneOf(r));let a=1,s=n+1;for(;a>0;){if(s>=e.length)throw new Error("Unmatched brackets or parentheses");e[s].isOneOf(t)?a-=1:e[s].isOneOf(r)&&(a+=1),s+=1}return s-1}function Z(e,n){return Oe(e,n,[C,Ce,Nr],[$,Le,Ar])}function xr(e){let n=new l(2,":").toNode(),r={},t=[];for(let a=0;a<e.length;a++){if(e[a].type!=="group")continue;let s=e[a],i=ye(s.items,n);if(i===-1||i===0)continue;if(t.push(a),s.items[i-1].eq(new l(1,"delim").toNode())){if(s.items.length!==3)throw new se("Invalid number of arguments for delim");r.delim=s.items[i+1]}else throw new se("Not implemented for other named parameters")}for(let a=t.length-1;a>=0;a--)e.splice(t[a],1);return[e,r]}function be(e){let n=[];for(let r=0;r<e;r++)n.push(new l(2,"'").toNode());return n}var F=new l(2,"/").toNode();function Er(e,n){let r=n;for(;r<e.length&&(e[r].head.type===6||e[r].head.type===8);)r++;return r===e.length?null:e[r]}function Sr(e){let n=!1,r=[];for(let t=0;t<e.length;t++){let a=e[t];(a.head.type===6||a.head.type===8)&&(n||Er(e,t+1)?.eq(F))||(a.eq(F)?n=!0:n=!1,r.push(a))}return r}function Tr(e){e=Sr(e);let n=[],r=[],t=0;for(;t<e.length;){let a=e[t];if(a.eq(F))n.push(a);else if(n.length>0&&n[n.length-1].eq(F)){let s=a;if(r.length===0)throw new se("Unexpected '/' operator, no numerator before it");let i=r.pop();s.type==="leftright"&&(s=s.body),i.type==="leftright"&&(i=i.body),r.push(new Ne([i,s])),n.pop()}else r.push(a);t++}return r.length===1?r[0]:new z(r)}function kr(e){let n=new l(2,":").toNode(),r={};for(let t of e)d(t.items.length==3),d(t.items[1].eq(n)),r[t.items[0].toString()]=new ke(new l(3,t.items[2].toString()));return r}var se=class extends Error{constructor(e){super(e),this.name="TypstParserError"}},ve=new l(7,"_"),qe=new l(7,"^"),C=new l(2,"("),$=new l(2,")"),Ce=new l(2,"["),Le=new l(2,"]"),Nr=new l(2,"{"),Ar=new l(2,"}"),Q=new l(2,","),Mr=new l(2,";"),Or=new l(7,"&"),Cr=class{space_sensitive;newline_sensitive;constructor(e=!0,n=!0){this.space_sensitive=e,this.newline_sensitive=n}parse(e){let[n,r]=this.parseGroup(e,0,e.length);return n}parseGroup(e,n,r){return this.parseUntil(e.slice(n,r),0,null)}parseNextExpr(e,n){let[r,t]=this.parseNextExprWithoutSupSub(e,n),a=null,s=null,i=me(e,t);if(i>0&&(r=new z([r].concat(be(i))),t+=i),t<e.length&&e[t].eq(ve)?([a,t]=this.parseSupOrSub(e,t+1),t<e.length&&e[t].eq(qe)&&([s,t]=this.parseSupOrSub(e,t+1))):t<e.length&&e[t].eq(qe)&&([s,t]=this.parseSupOrSub(e,t+1),t<e.length&&e[t].eq(ve)&&([a,t]=this.parseSupOrSub(e,t+1))),a!==null||s!==null){let u={base:r,sup:s,sub:a};return[new G(u),t]}else return[r,t]}parseUntil(e,n,r,t={}){t.spaceSensitive===void 0&&(t.spaceSensitive=this.space_sensitive),t.newlineSensitive===void 0&&(t.newlineSensitive=this.newline_sensitive);let a=[],s=n;for(;s<e.length&&!(r!==null&&e[s].eq(r));){let[u,c]=this.parseNextExpr(e,s);s=c,!((u.head.type===6||u.head.type===8)&&(!t.spaceSensitive&&u.head.value.replace(/ /g,"").length===0||!t.newlineSensitive&&u.head.value===`
`))&&a.push(u)}return s>=e.length&&r!==null?[l.NONE.toNode(),-1]:[Tr(a),s+1]}parseSupOrSub(e,n){let r,t;if(e[n].eq(C)){if([r,t]=this.parseUntil(e,n+1,$),t===-1)throw new Error("Unmatched '('")}else[r,t]=this.parseNextExprWithoutSupSub(e,n);let a=me(e,t);return a>0&&(r=new z([r].concat(be(a))),t+=a),[r,t]}parseNextExprWithoutSupSub(e,n){let r=e[n],t=r.toNode();if(r.eq(C)){let[a,s]=this.parseUntil(e,n+1,$);if(s===-1)throw new Error("Unmatched '('");return[new D(null,{body:a,left:C,right:$}),s]}if(r.type===2&&!Re(r.value[0]))return[t,n+1];if([2,1].includes(r.type)&&n+1<e.length&&e[n+1].eq(C)){if(r.value==="mat"){let[u,c,h]=this.parseMatrix(e,n+1,Mr,Q),p=new v(r,u);return p.setOptions(c),[p,h]}if(r.value==="cases"){let[u,c,h]=this.parseMatrix(e,n+1,Q,Or),p=new v(r,u);return p.setOptions(c),[p,h]}if(r.value==="lr")return this.parseLrArguments(e,n+1);if(["#heading","#text"].includes(r.value)){let[u,c]=this.parseArguments(e,n+1),h=kr(u);d(e[c].eq(Ce));let p=new l(2,"$"),y=Oe(e,c+1,[p],[p]),[N,ue]=this.parseGroup(e,c+2,y);d(e[y+1].eq(Le));let ce=new Ae(r,[N]);return ce.setOptions(h),[ce,y+2]}let[a,s]=this.parseArguments(e,n+1);return[new b(r,a),s]}return[t,n+1]}parseArguments(e,n){let r=Z(e,n);return[this.parseArgumentsWithSeparator(e,n+1,r,Q),r+1]}parseLrArguments(e,n){let r=new l(1,"lr"),t=Z(e,n),a=null,s=null,i=n+1,u=t;u>i&&e[i].isOneOf(l.LEFT_DELIMITERS)&&(a=e[i],i+=1),u-1>i&&e[u-1].isOneOf(l.RIGHT_DELIMITERS)&&(s=e[u-1],u-=1);let[c,h]=this.parseGroup(e,i,u);return[new D(r,{body:c,left:a,right:s}),t+1]}parseMatrix(e,n,r,t){let a=Z(e,n),s=[],i={},u=n+1;for(;u<a;)for(;u<a;){let c=ye(e,r,u);(c===-1||c>a)&&(c=a);let h=this.parseArgumentsWithSeparator(e,u,c,t),p={};[h,p]=xr(h),s.push(h),Object.assign(i,p),u=c+1}return[s,i,a+1]}parseArgumentsWithSeparator(e,n,r,t){let a=[],s=n;for(;s<r;){let i,u,c={spaceSensitive:!1,newlineSensitive:!0};[i,u]=this.parseUntil(e.slice(0,r),s,t,c),u==-1&&([i,u]=this.parseUntil(e.slice(0,r),s,null,c)),a.push(i),s=u}return a}};function Lr(e){let n=new Cr,r=yr(e);return n.parse(r)}var zr=class{buffer="";queue=[];append(e){this.queue=this.queue.concat(e.serialize())}flushQueue(){for(;this.queue.length>0;){let e=this.queue[this.queue.length-1];if(e.eq(o.COMMAND_DISPLAYSTYLE)||e.eq(o.COMMAND_TEXTSTYLE))this.queue.pop();else break}for(let e=0;e<this.queue.length;e++)this.buffer=_e(this.buffer,this.queue[e]);this.queue=[]}finalize(){return this.flushQueue(),this.buffer}};function ze(e,n={}){let r={nonStrict:!0,preferShorthands:!0,keepSpaces:!1,fracToSlash:!0,inftyToOo:!1,optimize:!0,customTexMacros:{}};if(typeof n!="object")throw new Error("options must be an object");for(let i in r)i in n&&(r[i]=n[i]);let t=Je(e,r.customTexMacros),a=g(t,r),s=new ar(r);return s.serialize(a),s.finalize()}function De(e,n={}){let r={blockMathMode:!0};if(typeof n!="object")throw new Error("options must be an object");for(let i in r)i in n&&(r[i]=n[i]);let t=Lr(e),a=Me(t,r),s=new zr;return s.append(a),s.finalize()}globalThis.tex2typst=ze;globalThis.typst2tex=De;})();
